(function(){"use strict";var n={7397:function(n,e,t){var o=t(9242),r=t(3396),i=t(7139);const a={key:0},c={key:0},l=(0,r._)("br",null,null,-1),s=(0,r._)("br",null,null,-1),u=(0,r._)("br",null,null,-1),d=(0,r._)("br",null,null,-1),f=(0,r._)("br",null,null,-1),p={key:1,style:{width:"800px",margin:"0 auto"}},g=(0,r._)("h4",null,"Connections",-1),v={style:{"text-align":"left"}},y={key:2},w=(0,r._)("br",null,null,-1),m=(0,r._)("br",null,null,-1),h={key:0,style:{"text-align":"left",width:"400px",margin:"0 auto",border:"1px solid #eee",padding:"10px"}};function b(n,e,t,b,k,S){return(0,r.wg)(),(0,r.iD)("div",null,[b.peerId?((0,r.wg)(),(0,r.iD)("div",a,[b.peerId?((0,r.wg)(),(0,r.iD)("h2",c,"peerId: "+(0,i.zw)(b.peerId),1)):(0,r.kq)("",!0),l,s,(0,r._)("div",null,[(0,r.wy)((0,r._)("input",{"onUpdate:modelValue":e[0]||(e[0]=n=>b.multiaddress=n),type:"text"},null,512),[[o.nr,b.multiaddress]]),u,(0,r._)("button",{onClick:e[1]||(e[1]=(...n)=>b.connectClick&&b.connectClick(...n))},"connect")]),d,f,b.connections.length>1?((0,r.wg)(),(0,r.iD)("div",p,[g,(0,r._)("ul",v,[((0,r.wg)(!0),(0,r.iD)(r.HY,null,(0,r.Ko)(b.connections,((n,e)=>((0,r.wg)(),(0,r.iD)("li",{key:e,style:{margin:"10px"}},(0,i.zw)(n),1)))),128))])])):(0,r.kq)("",!0),b.connectionPeerId?((0,r.wg)(),(0,r.iD)("div",y,[(0,r.Uk)(" control: "+(0,i.zw)(b.connectionPeerId)+" ",1),w,m,(0,r._)("button",{onClick:e[2]||(e[2]=(...n)=>b.launchClick&&b.launchClick(...n))},(0,i.zw)(b.stateLamp),1),b.data?((0,r.wg)(),(0,r.iD)("pre",h,(0,i.zw)(b.data),1)):(0,r.kq)("",!0)])):(0,r.kq)("",!0)])):((0,r.wg)(),(0,r.iD)("button",{key:1,onClick:e[3]||(e[3]=(...n)=>b.startClick&&b.startClick(...n))},"start node")),(0,r._)("div",null,(0,i.zw)(b.error),1)])}var k=t(4870),S=t(3779),C=t(5905),_=t(2158),O=t(2521),P=t(1279),x=t(9484),I=t(783),E=t(8936),D=t(5211),T=t(2543),H=t(7010);function z(){return n=>{async function e(n){return(0,D.z)(n,(async function(n){let e="";for await(const o of n)e+=(0,H.B)(o.subarray());try{return JSON.parse(e)}catch(t){console.log(t)}}))}async function t(n,e){return(0,D.z)([(0,T.m)(JSON.stringify(e))],n.sink).finally((()=>{n.close()}))}return{async handle(t,o,r={runOnTransientConnection:!0}){await n.registrar.handle(t,(async({stream:n,connection:t})=>{o(await e(n),n,t)}),r)},async request(n,e,t,o={runOnTransientConnection:!0}){if("open"!==n.status)return;const r=await n.newStream([e],o);return(0,D.z)([(0,T.m)(JSON.stringify(t))],r,(async function(n){let e="";for await(const o of n)e+=(0,H.B)(o.subarray());try{return JSON.parse(e)}catch(t){return e}}))},utils:{getRequest:e,sendResponse:t}}}}async function L(){const n=await(0,E.N)({transports:[(0,P.E)({filter:x.$6}),(0,C.f)()],streamMuxers:[(0,O.R)()],connectionEncryption:[(0,S.t)()],services:{identify:(0,_.y)(),ha:z()},connectionGater:{denyDialMultiaddr:()=>!1},connectionManager:{minConnections:0}});return n}function j(n){return new Promise(((e,t)=>{const o=setTimeout((()=>{t(new Error("timeout"))}),1e4),r=new WebSocket(n);r.addEventListener("error",(()=>{clearTimeout(o),t(new Error("connect"))})),r.addEventListener("open",(()=>{r.close(),clearTimeout(o),e()}))}))}async function M(n){let e="ws";"https:"===location.protocol&&(e="wss");const t=(0,I.HM)(n),o=t.protoNames(),r=()=>"wss"===e?o.includes("wss"):o.includes("ws")||o.includes("wss");if(r()){if(o.includes("p2p-circuit"))return t;{const n=t.nodeAddress();try{return await j(`${o.includes("wss")?"wss":"ws"}://${n.address}:${n.port}`),t}catch(i){console.log(i)}}}return!1}let q=null;async function A(n){if(q)return q;async function e(){const e=q.getConnections().map((n=>n.remoteAddr.toString()));console.log("Update Connections List",e),n(e)}return q=await L(),await q.start(),console.log(`Node started with id ${q.peerId.toString()}`),q.addEventListener("connection:open",(n=>{console.log("connected",n.detail.remoteAddr.toString()),e()})),q.addEventListener("connection:close",(n=>{console.log("disconected",n.detail.remoteAddr.toString()),e()})),q.addEventListener("peer:discovery",(n=>{console.log("Discovered:",n.detail.id.toString())})),q}async function N(n){if(!q)return!1;const e=q.getConnections().find((e=>e.remoteAddr.toString()===n));if(e)return e;try{const e=(0,I.HM)(n);return await q.dial(e)}catch(t){console.log(t)}return!1}function $(n,e){const t=q.getConnections().find((e=>e.remotePeer.toString()===n));if(q&&t)return q.services.ha.request(t,"/call",e);throw new Error("error")}const J=()=>{const n=(0,k.iH)(null),e=(0,k.iH)(null),t=(0,k.iH)(null),o=(0,k.iH)(null),r=async n=>{const e=await A(n);return t.value=e.peerId.toString(),i(e),!0},i=async t=>{try{const r=t.getProtocols();r.includes("/update")&&await t.unhandle("/update"),t.services.ha.handle("/update",(async(r,i,a)=>{console.log("from",a.remotePeer.toString()),console.log(o.value),o.value===a.remoteAddr.toString()?(n.value=r,e.value=Date.now(),await t.services.ha.utils.sendResponse(i,{result:!0})):console.log("skip update")}))}catch(r){console.log(`Error: ${r.message}`),console.log(r)}},a=async n=>{try{const e=await M(n);return console.log("connect",e.toString()),await N(e)}catch(e){console.log(`Error: ${e.message}`),console.log(e)}return!1},c=async(n,e)=>{console.log("Launch command",e);const t=n.split("/"),o=await $(t[t.length-1],{data:e});console.log("response:",o)};return{data:n,connectionPeerId:o,updateTime:e,run:r,connectPeer:a,launch:c,peerId:t}};var R={setup(){const n=(0,k.iH)([]),e=(0,k.iH)(),t=(0,k.iH)(),{data:o,connectionPeerId:i,updateTime:a,run:c,launch:l,connectPeer:s,peerId:u}=J(),d=async()=>{await c((e=>{n.value=e}))},f=async()=>{const n=await s(t.value);n&&(v(n.remoteAddr.toString()),t.value="")},p=(0,r.Fl)((()=>{let n="on";return o.value&&"on"===o.value.data.lamp.state&&(n="off"),n})),g=async()=>{if(e.value=void 0,!i.value)return;let n="on";o.value&&"on"===o.value.data.lamp.state&&(n="off");try{await l(i.value,{device:"lamp",state:n})}catch(t){e.value=t.message}},v=n=>{i.value=n,o.value=null,e.value=void 0};return{multiaddress:t,data:o,updateTime:a,startClick:d,connectClick:f,launchClick:g,peerId:u,connectionPeerId:i,stateLamp:p,connections:n,select:v,error:e}}},U=t(89);const B=(0,U.Z)(R,[["render",b]]);var F=B;(0,o.ri)(F).mount("#app")}},e={};function t(o){var r=e[o];if(void 0!==r)return r.exports;var i=e[o]={exports:{}};return n[o].call(i.exports,i,i.exports,t),i.exports}t.m=n,function(){var n=[];t.O=function(e,o,r,i){if(!o){var a=1/0;for(u=0;u<n.length;u++){o=n[u][0],r=n[u][1],i=n[u][2];for(var c=!0,l=0;l<o.length;l++)(!1&i||a>=i)&&Object.keys(t.O).every((function(n){return t.O[n](o[l])}))?o.splice(l--,1):(c=!1,i<a&&(a=i));if(c){n.splice(u--,1);var s=r();void 0!==s&&(e=s)}}return e}i=i||0;for(var u=n.length;u>0&&n[u-1][2]>i;u--)n[u]=n[u-1];n[u]=[o,r,i]}}(),function(){t.n=function(n){var e=n&&n.__esModule?function(){return n["default"]}:function(){return n};return t.d(e,{a:e}),e}}(),function(){t.d=function(n,e){for(var o in e)t.o(e,o)&&!t.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:e[o]})}}(),function(){t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(n){if("object"===typeof window)return window}}()}(),function(){t.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)}}(),function(){t.r=function(n){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})}}(),function(){var n={143:0};t.O.j=function(e){return 0===n[e]};var e=function(e,o){var r,i,a=o[0],c=o[1],l=o[2],s=0;if(a.some((function(e){return 0!==n[e]}))){for(r in c)t.o(c,r)&&(t.m[r]=c[r]);if(l)var u=l(t)}for(e&&e(o);s<a.length;s++)i=a[s],t.o(n,i)&&n[i]&&n[i][0](),n[i]=0;return t.O(u)},o=self["webpackChunkdapp_libp2p"]=self["webpackChunkdapp_libp2p"]||[];o.forEach(e.bind(null,0)),o.push=e.bind(null,o.push.bind(o))}();var o=t.O(void 0,[998],(function(){return t(7397)}));o=t.O(o)})();
//# sourceMappingURL=app.d3b0925e.js.map